<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorlesungsplaner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        .timetable-grid {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            grid-template-rows: 40px repeat(56, 15px);
            gap: 2px;
        }
        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(120px, auto);
        }
        .time-header, .day-header {
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .time-header {
            top: 40px;
            left: 0;
            z-index: 10;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
         .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .today {
            background-color: #e0f2fe;
        }
        .day-events::-webkit-scrollbar {
            width: 4px;
        }
        .day-events::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Dein Semesterplan</h1>
                <p class="text-gray-500 mt-1">Verwalte hier deine Vorlesungen und Termine.</p>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
                <div class="flex items-center bg-gray-200 rounded-lg p-1">
                    <button id="weekViewBtn" class="px-3 py-1 text-sm font-semibold rounded-md transition-colors bg-white text-blue-600 shadow">Woche</button>
                    <button id="monthViewBtn" class="px-3 py-1 text-sm font-semibold rounded-md transition-colors text-gray-600">Monat</button>
                </div>
                <button id="examPrepBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                    ✨ Klausur-Vorbereitung
                </button>
                 <button id="prepareTodayBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200">
                    ✨ Heutige Vorbereitung
                </button>
                <button id="addLectureBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    + Neue Vorlesung
                </button>
            </div>
        </header>

        <div id="calendarContainer">
            <div id="weekViewContainer" class="bg-white rounded-xl shadow-lg overflow-auto">
                 <div id="timetable" class="timetable-grid relative"></div>
            </div>
            <div id="monthViewContainer" class="hidden">
                 <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-xl shadow-lg">
                    <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                    <h2 id="monthYearHeader" class="text-xl font-bold"></h2>
                    <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                </div>
                <div id="monthGrid" class="month-grid bg-white rounded-xl shadow-lg border border-gray-200"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
            <div id="icalSection" class="p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4">Kalender-Abonnements (iCal)</h2>
                <div class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="url" id="icalUrlInput" placeholder="https://beispiel.com/kalender.ics" class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="addIcalBtn" class="bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-gray-700 transition duration-200">Abonnieren</button>
                </div>
                <div id="icalList" class="space-y-2"></div>
            </div>
            <div id="driveSyncSection" class="p-6 bg-white rounded-xl shadow-lg">
                 <h2 class="text-xl font-bold mb-4">Google Drive Sync</h2>
                 <p id="drive-status" class="text-sm text-gray-500 mb-4">Verbinde dein Google-Konto, um Daten zu laden und zu sichern.</p>
                 <div id="drive-auth-container">
                    <button id="drive-auth-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">Mit Google Drive verbinden</button>
                 </div>
                 <div id="drive-action-container" class="hidden space-y-2">
                     <button id="drive-load-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 transition duration-200">Daten aus Drive Laden</button>
                     <button id="drive-save-btn" class="w-full bg-gray-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-gray-800 transition duration-200">Daten in Drive Speichern</button>
                     <button id="drive-signout-btn" class="w-full mt-4 text-sm text-red-500 hover:underline">Verbindung trennen</button>
                 </div>
            </div>
        </div>

        <footer class="text-center text-gray-400 mt-8 text-sm">
             <p>Erweitert mit Gemini.</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="lectureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-all overflow-y-auto max-h-screen">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold">Neue Vorlesung hinzufügen</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <form id="lectureForm">
                <input type="hidden" id="lectureId">
                <div class="space-y-4">
                    <div>
                        <label for="courseName" class="block text-sm font-medium text-gray-700">Vorlesungsname</label>
                        <input type="text" id="courseName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="lecturer" class="block text-sm font-medium text-gray-700">Dozent/in</label>
                        <input type="text" id="lecturer" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="room" class="block text-sm font-medium text-gray-700">Raum</label>
                        <input type="text" id="room" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="dayOfWeek" class="block text-sm font-medium text-gray-700">Wochentag</label>
                        <select id="dayOfWeek" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">Montag</option>
                            <option value="2">Dienstag</option>
                            <option value="3">Mittwoch</option>
                            <option value="4">Donnerstag</option>
                            <option value="5">Freitag</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="startTime" class="block text-sm font-medium text-gray-700">Startzeit</label>
                            <input type="time" id="startTime" step="900" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="endTime" class="block text-sm font-medium text-gray-700">Endzeit</label>
                            <input type="time" id="endTime" step="900" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end items-center mt-8 space-x-4">
                     <button id="deleteLectureBtn" type="button" class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition duration-200 hidden">Löschen</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200">Speichern</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="preparationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl m-4 transform transition-all max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 class="text-2xl font-bold text-gray-900">✨ Vorbereitung für Heute</h2>
                <button id="closePrepModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div id="preparationContent" class="overflow-y-auto space-y-6">
                <div id="prepLoader" class="flex justify-center items-center py-16">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="lectureDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl m-4 transform transition-all max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center pb-4 border-b">
                <div>
                    <h2 id="detailModalTitle" class="text-2xl font-bold text-gray-900">Vorlesungsdetails</h2>
                    <p id="detailModalSubtitle" class="text-gray-500"></p>
                </div>
                <button id="closeDetailModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="overflow-y-auto mt-6 flex-grow">
                 <div id="recordingSection" class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Aufnahme & Zusammenfassung</h3>
                    <div id="recordingStatus" class="text-gray-600 mb-4"></div>
                    <button id="startRecordingBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                        🎤 Aufnahme & Zusammenfassung starten
                    </button>
                    <button id="stopRecordingBtn" class="w-full bg-red-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 hidden pulse">
                        🛑 Aufnahme stoppen & Zusammenfassung erstellen
                    </button>
                    <div id="liveTranscript" class="mt-4 p-2 bg-white rounded h-24 overflow-y-auto text-sm text-gray-500 border hidden"></div>
                 </div>
                 <div id="summarySection" class="mt-6">
                      <h3 class="font-bold text-lg mb-2">Gespeicherte Zusammenfassungen</h3>
                      <div id="pastSummariesContainer" class="space-y-2">
                           <p class="text-gray-500">Keine Zusammenfassungen für diese Vorlesung gefunden.</p>
                      </div>
                 </div>
            </div>
             <div class="pt-4 mt-4 border-t flex justify-end">
                 <button id="editLectureBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300 transition duration-200">Bearbeiten</button>
             </div>
        </div>
    </div>
    
    <div id="examPrepModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl m-4 transform transition-all max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 class="text-2xl font-bold text-gray-900">✨ Klausur-Vorbereitung</h2>
                <button id="closeExamPrepModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div id="examPrepContent" class="overflow-y-auto">
                <!-- Content is generated dynamically -->
            </div>
        </div>
    </div>

    <div id="messageBox" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-[100]">
        <p id="messageText"></p>
    </div>

    <!-- The ical.js library is loaded synchronously before the main app module. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/2.0.0/ical.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            var timetable = document.getElementById('timetable');
            var lectureModal = document.getElementById('lectureModal');
            var weekViewBtn = document.getElementById('weekViewBtn');
            var monthViewBtn = document.getElementById('monthViewBtn');
            var weekViewContainer = document.getElementById('weekViewContainer');
            var monthViewContainer = document.getElementById('monthViewContainer');
            var monthGrid = document.getElementById('monthGrid');
            var monthYearHeader = document.getElementById('monthYearHeader');
            var prevMonthBtn = document.getElementById('prevMonthBtn');
            var nextMonthBtn = document.getElementById('nextMonthBtn');
            var addIcalBtn = document.getElementById('addIcalBtn');
            var icalUrlInput = document.getElementById('icalUrlInput');
            var icalList = document.getElementById('icalList');
            var addLectureBtn = document.getElementById('addLectureBtn');
            var closeModalBtn = document.getElementById('closeModalBtn');
            var lectureForm = document.getElementById('lectureForm');
            var modalTitle = document.getElementById('modalTitle');
            var deleteLectureBtn = document.getElementById('deleteLectureBtn');
            var messageBox = document.getElementById('messageBox');
            var messageText = document.getElementById('messageText');
            var prepareTodayBtn = document.getElementById('prepareTodayBtn');
            var preparationModal = document.getElementById('preparationModal');
            var closePrepModalBtn = document.getElementById('closePrepModalBtn');
            var preparationContent = document.getElementById('preparationContent');
            var prepLoader = document.getElementById('prepLoader');
            var lectureDetailModal = document.getElementById('lectureDetailModal');
            var closeDetailModalBtn = document.getElementById('closeDetailModalBtn');
            var detailModalTitle = document.getElementById('detailModalTitle');
            var detailModalSubtitle = document.getElementById('detailModalSubtitle');
            var editLectureBtn = document.getElementById('editLectureBtn');
            var startRecordingBtn = document.getElementById('startRecordingBtn');
            var stopRecordingBtn = document.getElementById('stopRecordingBtn');
            var recordingStatus = document.getElementById('recordingStatus');
            var liveTranscript = document.getElementById('liveTranscript');
            var pastSummariesContainer = document.getElementById('pastSummariesContainer');
            var examPrepBtn = document.getElementById('examPrepBtn');
            var examPrepModal = document.getElementById('examPrepModal');
            var closeExamPrepModalBtn = document.getElementById('closeExamPrepModalBtn');
            var examPrepContent = document.getElementById('examPrepContent');
            var driveStatus = document.getElementById('drive-status');
            var driveAuthContainer = document.getElementById('drive-auth-container');
            var driveActionContainer = document.getElementById('drive-action-container');
            var driveAuthBtn = document.getElementById('drive-auth-btn');
            var driveLoadBtn = document.getElementById('drive-load-btn');
            var driveSaveBtn = document.getElementById('drive-save-btn');
            var driveSignoutBtn = document.getElementById('drive-signout-btn');
            
            // --- App State ---
            var appData = { lectures: [], icalSubscriptions: [], summaries: {} };
            var icalEvents = [];
            var currentLecture = null;
            var currentView = 'week';
            var displayedDate = new Date();
            var colors = ['bg-blue-100', 'bg-green-100', 'bg-yellow-100', 'bg-purple-100', 'bg-pink-100', 'bg-indigo-100', 'bg-teal-100'];
            var courseColorMap = {};
            var colorIndex = 0;
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            var recognition;
            var isRecording = false;
            var finalTranscript = '';
            var tokenClient;
            var gapiInited = false;
            var gisInited = false;
            var driveFileId = null;
            var DATA_FILE_NAME = 'semesterplaner_data.json';
            
            // --- API Keys (Replace placeholders!) ---
            // =================================================================================
            // HIER DEINE GOOGLE- & GEMINI-ZUGANGSDATEN EINTRAGEN
            // Eine Anleitung dazu findest du in der Datei 'anleitung_api_keys.md'
            // =================================================================================
            var GEMINI_API_KEY = "AIzaSyBQqOGOLhLFRngWcNzMiPu3OyDgvYZhNXo"; // *** NEU ***
            var GOOGLE_API_KEY = "DEIN_GOOGLE_DRIVE_API_KEY"; // War vorher API_KEY
            var GOOGLE_CLIENT_ID = "DEINE_GOOGLE_DRIVE_CLIENT_ID.apps.googleusercontent.com"; // War vorher CLIENT_ID
            // =================================================================================
            
            var DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
            var SCOPES = 'https://www.googleapis.com/auth/drive.file';

            window.gapiLoaded = function() {
                gapi.load('client', initializeGapiClient);
            };

            function initializeGapiClient() {
                if (GOOGLE_API_KEY === "DEIN_GOOGLE_DRIVE_API_KEY") return;
                gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                }).then(function() {
                    gapiInited = true;
                });
            }

            window.gisLoaded = function() {
                if (GOOGLE_CLIENT_ID === "DEINE_GOOGLE_DRIVE_CLIENT_ID.apps.googleusercontent.com") return;
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: '', 
                });
                gisInited = true;
            };

            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            function saveData() {
                try {
                    localStorage.setItem('semesterPlanerData', JSON.stringify(appData));
                } catch (e) {
                    console.error("Could not save data to localStorage", e);
                    showMessage("Lokale Daten konnten nicht gespeichert werden.", true);
                }
            }

            function loadData() {
                try {
                    var data = localStorage.getItem('semesterPlanerData');
                    if (data) {
                        appData = JSON.parse(data);
                        if (!appData.summaries) appData.summaries = {};
                    }
                } catch (e) {
                    console.error("Could not load data from localStorage", e);
                    showMessage("Gespeicherte lokale Daten konnten nicht geladen werden.", true);
                }
            }

            function main() {
                loadData();
                setupEventListeners();
                switchView('week');
                renderIcalList();
                fetchAllIcalEvents();
                renderCurrentView();
                setInterval(highlightCurrentLecture, 60 * 1000); // Check current lecture every minute
            }
            
            // --- All UI and core logic functions ---
            
            function switchView(view) {
                currentView = view;
                if (view === 'week') {
                    weekViewContainer.classList.remove('hidden');
                    monthViewContainer.classList.add('hidden');
                    weekViewBtn.classList.add('bg-white', 'text-blue-600', 'shadow');
                    monthViewBtn.classList.remove('bg-white', 'text-blue-600', 'shadow');
                } else {
                    weekViewContainer.classList.add('hidden');
                    monthViewContainer.classList.remove('hidden');
                    weekViewBtn.classList.remove('bg-white', 'text-blue-600', 'shadow');
                    monthViewBtn.classList.add('bg-white', 'text-blue-600', 'shadow');
                }
                renderCurrentView();
            }

            function renderCurrentView() {
                // Ensure elements exist before trying to render
                if (currentView === 'week' && timetable) {
                    renderTimetable();
                } else if (currentView === 'month' && monthGrid) {
                    renderMonthView();
                }
            }
            
            function fetchAllIcalEvents() {
                icalEvents = [];
                // Check if icalSubscriptions exists and is an array
                if (!appData.icalSubscriptions || !Array.isArray(appData.icalSubscriptions)) {
                    appData.icalSubscriptions = [];
                }
                var promises = appData.icalSubscriptions.map(function(sub) {
                    return fetchAndParseICal(sub.url);
                });
                Promise.all(promises).then(function(results) {
                    // Flatten results: [].concat.apply([], results) is a way to flatten arrays in ES5
                    icalEvents = [].concat.apply([], results);
                    renderCurrentView(); // Re-render after fetching
                }).catch(function(err){
                    console.error("Error fetching all iCal events:", err);
                    // Optionally show a message to the user
                });
            }
            
            function fetchAndParseICal(url) {
                var proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                return fetch(proxyUrl).then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP-Fehler: ' + response.status);
                    }
                    return response.text();
                }).then(function(icsData) {
                    try {
                        var jcalData = ICAL.parse(icsData);
                        var comp = new ICAL.Component(jcalData);
                        var vevents = comp.getAllSubcomponents('vevent');
                        
                        return vevents.map(function(vevent) {
                            var event = new ICAL.Event(vevent);
                            // Basic validation for event dates
                            if (!event.startDate || !event.endDate) return null; 
                            return {
                                summary: event.summary || 'Unbenannter Termin',
                                startDate: event.startDate.toJSDate(),
                                endDate: event.endDate.toJSDate(),
                                isAllDay: event.isAllDay,
                            };
                        }).filter(function(event) { return event !== null; }); // Filter out invalid events
                    } catch (parseError) {
                         console.error('Error parsing iCal data from ' + url + ':', parseError);
                         showMessage('Kalenderformat ungültig: ' + url, true);
                         return [];
                    }
                }).catch(function(error) {
                    console.error('Error fetching iCal from ' + url + ':', error);
                    showMessage('Kalender konnte nicht geladen werden. (' + error.message + ')', true);
                    return [];
                });
            }
            
            function renderIcalList() {
                icalList.innerHTML = '';
                 if (!appData.icalSubscriptions || appData.icalSubscriptions.length === 0) {
                    icalList.innerHTML = '<p class="text-gray-500">Keine Kalender abonniert.</p>';
                    return;
                }
                appData.icalSubscriptions.forEach(function(sub) {
                    var div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md';
                    div.innerHTML = '<p class="text-sm truncate" title="' + sub.url + '">' + sub.url + '</p>' +
                                      '<button data-id="' + sub.id + '" class="delete-ical-btn text-red-500 hover:text-red-700 font-bold p-1 ml-2">&times;</button>';
                    icalList.appendChild(div);
                });
                // Use event delegation for delete buttons for robustness
                icalList.addEventListener('click', function(event) {
                    if (event.target.classList.contains('delete-ical-btn')) {
                        var id = event.target.dataset.id;
                        appData.icalSubscriptions = appData.icalSubscriptions.filter(function(s) { return s.id !== id; });
                        saveData();
                        renderIcalList(); // Re-render the list
                        fetchAllIcalEvents(); // Refetch events
                        showMessage("Abonnement entfernt.");
                    }
                });
            }
            
            function renderMonthView() {
                monthGrid.innerHTML = ''; // Clear previous grid
                var year = displayedDate.getFullYear();
                var month = displayedDate.getMonth();
                monthYearHeader.textContent = displayedDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                var firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon,...
                var daysInMonth = new Date(year, month + 1, 0).getDate();
                
                // Adjust offset for Monday start (0=Sun -> 6, 1=Mon -> 0, ...)
                var offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; 

                ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(function(day) {
                    var header = document.createElement('div');
                    header.className = 'text-center font-bold p-2 border-b';
                    header.textContent = day;
                    monthGrid.appendChild(header);
                });
                
                // Add empty cells for offset
                for (var i = 0; i < offset; i++) {
                    monthGrid.appendChild(createDayCell(null));
                }

                // Add cells for each day of the month
                for (var day = 1; day <= daysInMonth; day++) {
                    monthGrid.appendChild(createDayCell(new Date(year, month, day)));
                }
                 // Add trailing empty cells if needed
                var totalCells = offset + daysInMonth;
                var remainingCells = (7 - (totalCells % 7)) % 7;
                for (var j = 0; j < remainingCells; j++) {
                     monthGrid.appendChild(createDayCell(null));
                }
            }
            
            function createDayCell(date) {
                var cell = document.createElement('div');
                cell.className = 'border p-1 flex flex-col min-h-[120px]'; // Ensure min height
                if (!date) {
                    cell.classList.add('bg-gray-50');
                    return cell;
                }
                var dayNumber = document.createElement('span');
                dayNumber.className = 'font-semibold mb-1 self-start'; // Align day number top-left
                dayNumber.textContent = date.getDate();
                cell.appendChild(dayNumber);
                
                var today = new Date();
                // Compare only year, month, and day
                if (date.getFullYear() === today.getFullYear() &&
                    date.getMonth() === today.getMonth() &&
                    date.getDate() === today.getDate()) {
                    cell.classList.add('today');
                    dayNumber.classList.add('bg-blue-600', 'text-white', 'rounded-full', 'w-6', 'h-6', 'flex', 'items-center', 'justify-center');
                }
                
                var eventsContainer = document.createElement('div');
                eventsContainer.className = 'day-events flex-grow overflow-y-auto space-y-1';
                
                // Get day of week (adjusting Sunday from 0 to 7 for consistency if needed)
                var dayOfWeek = date.getDay(); // 0=Sun, 1=Mon,...
                if (dayOfWeek === 0) dayOfWeek = 7; // Treat Sunday as 7 if needed by lecture data format (1-5)

                // Filter lectures scheduled for this weekday (recurring)
                 if (!appData.lectures) appData.lectures = []; // Ensure lectures array exists
                 appData.lectures.filter(function(l) {
                    // Assuming dayOfWeek in lecture is 1-5 (Mon-Fri)
                    return parseInt(l.dayOfWeek) === dayOfWeek; 
                }).forEach(function(l) {
                    eventsContainer.appendChild(createEventElement(l.courseName, l.startTime, getCourseColor(l.courseName)));
                });

                // Filter iCal events for this specific date
                if (!icalEvents) icalEvents = []; // Ensure icalEvents array exists
                icalEvents.filter(function(e) {
                     return e.startDate && e.startDate.toDateString() === date.toDateString();
                }).forEach(function(e) {
                    var time = e.isAllDay ? 'Ganztägig' : e.startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    eventsContainer.appendChild(createEventElement(e.summary, time, 'bg-orange-100 border border-orange-300'));
                });

                cell.appendChild(eventsContainer);
                return cell;
            }
            
            function createEventElement(summary, time, colorClass) {
                var eventEl = document.createElement('div');
                eventEl.className = 'text-xs p-1 rounded-md truncate ' + colorClass;
                eventEl.title = time + ' - ' + summary;
                // Basic HTML escaping
                var safeSummary = summary.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                eventEl.innerHTML = '<span class="font-bold">' + time + '</span> ' + safeSummary;
                return eventEl;
            }

            function createLectureElement(lecture) {
                var start = lecture.startTime.split(':').map(Number);
                var end = lecture.endTime.split(':').map(Number);
                var startHour = start[0], startMinute = start[1];
                var endHour = end[0], endMinute = end[1];

                // Basic validation for times
                if (isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) {
                    console.error("Invalid time format for lecture:", lecture);
                    return document.createElement('div'); // Return empty div to avoid breaking grid
                }

                var startRow = (startHour - 7) * 4 + Math.floor(startMinute / 15) + 2; // Use Math.floor
                var endRow = (endHour - 7) * 4 + Math.floor(endMinute / 15) + 2; // Use Math.floor

                // Prevent negative rows or invalid spans
                startRow = Math.max(2, startRow);
                endRow = Math.max(startRow + 1, endRow); // Ensure endRow is at least one slot after startRow

                var element = document.createElement('div');
                element.className = 'lecture-item relative z-10 rounded-lg p-2 m-0.5 flex flex-col justify-start overflow-hidden cursor-pointer transition-shadow duration-200 hover:shadow-lg ' + getCourseColor(lecture.courseName);
                
                // Validate dayOfWeek before setting grid column
                 var dayCol = parseInt(lecture.dayOfWeek);
                 if (isNaN(dayCol) || dayCol < 1 || dayCol > 5) {
                     console.error("Invalid dayOfWeek for lecture:", lecture);
                     return document.createElement('div'); // Skip rendering this lecture
                 }
                element.style.gridColumn = dayCol + 1;
                element.style.gridRow = startRow + ' / ' + endRow;
                element.dataset.id = lecture.id;
                var duration = (endHour * 60 + endMinute) - (startHour * 60 + startMinute);
                
                // Basic HTML escaping for display
                var safeCourseName = (lecture.courseName || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                var safeLecturer = (lecture.lecturer || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                var safeRoom = (lecture.room || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");

                var innerHTML = '<strong class="text-sm font-bold text-gray-900 truncate">' + safeCourseName + '</strong>';
                if (duration >= 45) {
                    innerHTML += '<p class="text-xs text-gray-700 truncate">' + safeLecturer + '</p>';
                }
                if (duration >= 60) {
                    innerHTML += '<p class="text-xs text-gray-600 font-medium mt-auto">' + safeRoom + '</p>';
                }
                element.innerHTML = innerHTML;

                element.addEventListener('click', function() { openDetailModal(lecture); });
                return element;
            }

            function renderTimetable() {
                timetable.innerHTML = ''; 
                var days = ['', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];
                days.forEach(function(day, index) {
                    var dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header p-2 text-center font-semibold bg-white border-b-2 border-gray-200 ' + (day ? '' : 'sticky left-0');
                    if (index > 0) dayHeader.style.gridColumn = index + 1;
                    dayHeader.textContent = day;
                    timetable.appendChild(dayHeader);
                });
                for (var row = 0; row < 56; row++) {
                    for (var col = 0; col < 5; col++) {
                        var cell = document.createElement('div');
                        cell.className = 'border border-gray-100'; // Cell borders
                        cell.style.gridRow = row + 2;
                        cell.style.gridColumn = col + 2;
                        if (row % 4 === 0) {
                            cell.classList.add('border-t-gray-200'); // Hour lines
                        }
                        timetable.appendChild(cell);
                    }
                }
                for (var i = 7; i <= 20; i++) {
                    var timeHeader = document.createElement('div');
                    timeHeader.className = 'time-header text-xs text-right pr-2 pt-0.5 text-gray-400 bg-white border-r-2 border-gray-200 sticky';
                    var startRowForHour = (i - 7) * 4 + 2;
                    timeHeader.style.gridRow = startRowForHour + ' / span 4';
                    timeHeader.textContent = i + ':00';
                    timetable.appendChild(timeHeader);
                }
                if (!appData.lectures) appData.lectures = []; // Ensure array exists
                appData.lectures.forEach(function(lecture) { 
                    // Add error handling during element creation
                     try {
                          var lectureEl = createLectureElement(lecture);
                          if (lectureEl) timetable.appendChild(lectureEl);
                     } catch(e) {
                          console.error("Error creating lecture element:", lecture, e);
                     }
                });
                highlightCurrentLecture();
            }

            function getCourseColor(courseName) {
                 if (!courseName) return colors[0]; // Default color if name is missing
                if (!courseColorMap[courseName]) {
                    courseColorMap[courseName] = colors[colorIndex % colors.length];
                    colorIndex++;
                }
                return courseColorMap[courseName];
            }
            
            function highlightCurrentLecture() {
                document.querySelectorAll('.lecture-item').forEach(function(el) { el.classList.remove('ring-2', 'ring-blue-500', 'z-30'); });
                var now = new Date();
                var currentDay = now.getDay(); // 0=Sun, 1=Mon,...
                var hours = ('0' + now.getHours()).slice(-2);
                var minutes = ('0' + now.getMinutes()).slice(-2);
                var currentTime = hours + ':' + minutes;
                
                if (!appData.lectures) appData.lectures = []; // Ensure array exists

                var currentLectureItem = appData.lectures.find(function(l) {
                     // Ensure time comparison works correctly
                    return parseInt(l.dayOfWeek) === currentDay && 
                           l.startTime <= currentTime && 
                           l.endTime > currentTime;
                });
                
                if (currentLectureItem) {
                    var currentEl = document.querySelector('.lecture-item[data-id="' + currentLectureItem.id + '"]');
                    if (currentEl) currentEl.classList.add('ring-2', 'ring-blue-500', 'z-30');
                }
            }
            function openModal(lecture) {
                lecture = lecture || null;
                lectureForm.reset();
                if (lecture) {
                    modalTitle.textContent = 'Vorlesung bearbeiten';
                    document.getElementById('lectureId').value = lecture.id;
                    document.getElementById('courseName').value = lecture.courseName || '';
                    document.getElementById('lecturer').value = lecture.lecturer || '';
                    document.getElementById('room').value = lecture.room || '';
                    document.getElementById('dayOfWeek').value = lecture.dayOfWeek || '1';
                    document.getElementById('startTime').value = lecture.startTime || '';
                    document.getElementById('endTime').value = lecture.endTime || '';
                    deleteLectureBtn.classList.remove('hidden');
                } else {
                    modalTitle.textContent = 'Neue Vorlesung hinzufügen';
                    document.getElementById('lectureId').value = '';
                    deleteLectureBtn.classList.add('hidden');
                }
                lectureModal.classList.remove('hidden');
            }

            function closeModal() {
                lectureModal.classList.add('hidden');
            }
            
            function openDetailModal(lecture) {
                 if (!lecture) return; // Add check
                currentLecture = lecture;
                detailModalTitle.textContent = lecture.courseName || 'Unbekannt';
                detailModalSubtitle.textContent = (lecture.lecturer || 'N/A') + ' | Raum: ' + (lecture.room || 'N/A');
                lectureDetailModal.classList.remove('hidden');
                recordingStatus.textContent = "Startklar. Klicken Sie auf den Button, um die Aufnahme zu beginnen.";
                resetRecordingUI();
                loadPastSummaries(lecture.id);
            }
            
            function closeDetailModal() {
                if(isRecording && recognition) {
                     isRecording = false; // Prevent restart on manual close
                     recognition.stop();
                }
                lectureDetailModal.classList.add('hidden');
                currentLecture = null;
            }
            function parseGeminiResponse(text) {
                 if (typeof text !== 'string') return '';
                // Basic HTML escaping before applying markdown-like formatting
                text = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900">$1</strong>')
                           .replace(/\*(.*?)\*/g, '<em>$1</em>')
                           .replace(/^- (.*$)/gm, '<li class="list-disc ml-6">$1</li>')
                           .replace(/\n/g, '<br>');
            }

            function callGeminiAPI(prompt) {
                 if (GEMINI_API_KEY === "DEIN_GEMINI_API_KEY") {
                    showMessage("Bitte zuerst Gemini API Key im HTML-Code eintragen.", true);
                    return Promise.reject("Missing Gemini API Key");
                }
                var apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=' + GEMINI_API_KEY;
                var payload = { contents: [{ parts: [{ text: prompt }] }] };
                return fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                }).then(function(response) {
                    if (!response.ok) {
                         // Try to parse the error message from the response body
                        return response.text().then(function(text) { 
                           console.error("Gemini API Error Response:", text);
                           var errorMsg = 'API request failed: ' + response.status;
                           try { // Try to get more specific error from JSON
                                var errorJson = JSON.parse(text);
                                if (errorJson.error && errorJson.error.message) {
                                     errorMsg += " - " + errorJson.error.message;
                                }
                           } catch (e) { /* Ignore parsing error */ }
                           throw new Error(errorMsg);
                        });
                    }
                    return response.json();
                }).then(function(result) {
                    if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts[0] && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                         console.error("Invalid Gemini Response Structure:", result);
                         throw new Error("Unerwartete Antwortstruktur von der Gemini API.");
                    }
                });
            }
            
            function handlePreparationClick() {
                var now = new Date();
                var currentDay = now.getDay(); // 0=Sun, 1=Mon,...
                var todaysLectures = appData.lectures.filter(function(l) { return parseInt(l.dayOfWeek) === currentDay; })
                                                   .sort(function(a, b) { return a.startTime.localeCompare(b.startTime); });
                preparationModal.classList.remove('hidden');
                prepLoader.style.display = 'flex';
                preparationContent.innerHTML = '';
                preparationContent.appendChild(prepLoader);
                if (todaysLectures.length === 0) {
                     preparationContent.innerHTML = '<p class="text-center text-gray-600 py-10">Für heute sind keine Vorlesungen geplant. Genieße den freien Tag!</p>';
                     return;
                }
                var courseNames = todaysLectures.map(function(l) { return l.courseName; }).join(', ');
                var prompt = 'Du bist ein hilfreicher Studienassistent. Erstelle einen Vorbereitungsplan für einen Universitätsstudenten für die folgenden Kurse, die heute anstehen: ' + courseNames + '. Gib für jeden Kurs: 1. **Wahrscheinliches Kernthema**, 2. **Frage zum Nachdenken** und 3. **Wichtige Schlüsselbegriffe** (2-3). Formatiere die Antwort klar mit Markdown.';
                callGeminiAPI(prompt).then(function(responseText) {
                    preparationContent.innerHTML = '<div class="prose max-w-none">' + parseGeminiResponse(responseText) + '</div>';
                }).catch(function(error) {
                    console.error("Failed to get preparation plan:", error);
                    preparationContent.innerHTML = '<p class="text-center text-red-600 py-10">Leider konnte der Vorbereitungsplan nicht erstellt werden. Fehler: ' + error.message + '</p>';
                });
            }

            function handleExamPrepClick() {
                examPrepModal.classList.remove('hidden');
                examPrepContent.innerHTML = '';

                // Get unique course names using a simple loop for compatibility
                 var courseNames = {};
                 if (!appData.lectures) appData.lectures = [];
                 appData.lectures.forEach(function(l){ courseNames[l.courseName] = true; });
                 var uniqueCourseNames = Object.keys(courseNames);

                if (uniqueCourseNames.length === 0) {
                    examPrepContent.innerHTML = '<p class="text-center text-gray-600 py-10">Füge zuerst Vorlesungen hinzu, um die Klausurvorbereitung zu nutzen.</p>';
                    return;
                }

                var courseSelectionHTML = '<h3 class="text-lg font-semibold mb-4">Für welchen Kurs möchtest du dich vorbereiten?</h3><div class="flex flex-wrap gap-2">';
                uniqueCourseNames.forEach(function(name) {
                    // Basic escaping for data attribute
                    var safeName = name.replace(/"/g, '&quot;');
                    courseSelectionHTML += '<button class="exam-prep-course-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors" data-course-name="' + safeName + '">' + name + '</button>';
                });
                courseSelectionHTML += '</div>';
                examPrepContent.innerHTML = courseSelectionHTML;
                
                // Use event delegation for buttons inside dynamically generated content
                examPrepContent.addEventListener('click', function(event) {
                    if (event.target.classList.contains('exam-prep-course-btn')) {
                        generateExamPrepForCourse(event);
                    }
                });
            }
            
            function generateExamPrepForCourse(event) {
                var courseName = event.target.dataset.courseName;
                examPrepContent.innerHTML = '<div class="flex justify-center items-center py-16"><div class="loader"></div></div>';

                var lecturesForCourse = appData.lectures.filter(function(l) { return l.courseName === courseName; });
                var allSummaries = [];

                lecturesForCourse.forEach(function(lecture) {
                    if (appData.summaries[lecture.id]) {
                        var summariesForLecture = appData.summaries[lecture.id].map(function(s) { return s.summary; });
                        allSummaries = allSummaries.concat(summariesForLecture);
                    }
                });

                if (allSummaries.length === 0) {
                    examPrepContent.innerHTML = 
                        '<div class="text-center py-10">' +
                            '<p class="text-gray-600">Für den Kurs "' + courseName + '" wurden noch keine Zusammenfassungen gefunden.</p>' +
                            '<p class="text-sm text-gray-500 mt-2">Nutze die "Aufnahme & Zusammenfassung"-Funktion in den Vorlesungsdetails, um Inhalte zu sammeln.</p>' +
                        '</div>';
                    return;
                }

                var combinedSummaries = allSummaries.join("\n\n---\n\n");
                var prompt = "Du bist ein erfahrener Tutor. Basierend auf den folgenden Zusammenfassungen aus einer Vorlesungsreihe zum Thema '" + courseName + "', erstelle bitte eine umfassende Klausurvorbereitung auf Deutsch. Diese sollte beinhalten:\n1.  **Zentrale Kernthemen:** Eine Liste der 3-5 wichtigsten übergeordneten Themen, die in den Zusammenfassungen behandelt wurden.\n2.  **Mögliche Klausurfragen:** 3-4 anspruchsvolle, offene Fragen, die das Verständnis der Kernthemen testen.\n3.  **Wichtige Definitionen:** Eine Liste von Schlüsselbegriffen, die man für die Klausur definieren können sollte.\nFormatiere die Antwort klar und strukturiert mit Markdown.\n\nHier sind die gesammelten Zusammenfassungen:\n" + combinedSummaries;

                callGeminiAPI(prompt).then(function(responseText) {
                    examPrepContent.innerHTML = '<div class="prose max-w-none">' + parseGeminiResponse(responseText) + '</div>';
                }).catch(function(error) {
                    console.error("Failed to get exam prep:", error);
                    examPrepContent.innerHTML = '<p class="text-center text-red-600 py-10">Leider konnte die Klausurvorbereitung nicht erstellt werden. Fehler: ' + error.message + '</p>';
                });
            }


            function setupSpeechRecognition() {
                 if (!SpeechRecognition) {
                    showMessage("Spracherkennung wird von diesem Browser nicht unterstützt.", true);
                    return false;
                }
                // Check if recognition is already active to avoid errors
                if (recognition && isRecording) {
                     return true; // Already set up and running
                }

                recognition = new SpeechRecognition();
                recognition.continuous = true; 
                recognition.interimResults = true;
                recognition.lang = 'de-DE';

                recognition.onresult = function(event) {
                    var interimTranscript = '';
                    for (var i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript + ' '; 
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    if (liveTranscript) { // Check if element exists
                        liveTranscript.textContent = finalTranscript + interimTranscript;
                        liveTranscript.scrollTop = liveTranscript.scrollHeight; 
                    }
                };
                
                recognition.onend = function() {
                    console.log("Speech recognition ended naturally.");
                    if (isRecording) {
                        console.log("Restarting recognition...");
                         // Add a small delay before restarting, helps in some browsers
                        setTimeout(function() { 
                            if(isRecording && recognition) { // Double check flag
                                try { recognition.start(); } catch(e){ console.error("Error restarting recognition:", e);}
                            }
                        }, 250); 
                    }
                };

                recognition.onstart = function() {
                    console.log("Speech recognition started.");
                    if(recordingStatus) recordingStatus.textContent = "Aufnahme läuft... Sprechen Sie jetzt.";
                };

                recognition.onerror = function(event) {
                    console.error("Speech recognition error:", event.error, event.message);
                    var errorMessage = 'Fehler bei der Aufnahme: ' + event.error;
                    if (event.error === 'network') {
                        errorMessage = 'Netzwerkfehler bei der Spracherkennung. Prüfe die Internetverbindung.';
                    } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                         errorMessage = 'Zugriff auf Mikrofon verweigert. Bitte Berechtigung erteilen.';
                    } else if (event.error === 'audio-capture') {
                         errorMessage = 'Mikrofonproblem. Wird es von einer anderen App verwendet?';
                    } else if (event.error === 'aborted') {
                         console.log("Recognition aborted, likely intentional stop.");
                         // Don't show error message for manual stops
                         isRecording = false; // Ensure flag is false
                         resetRecordingUI();
                         return; // Stop further processing for abort
                    } else if (event.error === 'no-speech') {
                         console.log("No speech detected, continuing...");
                         // No user message needed, just let it restart or be stopped manually
                         return; 
                    }
                    
                    showMessage(errorMessage, true);
                     if (isRecording) { // Only reset if it was supposed to be running
                        isRecording = false;
                        resetRecordingUI();
                     }
                };
                return true;
            }

            function handleStartRecording() {
                if (isRecording) return;
                
                if (setupSpeechRecognition()) {
                    finalTranscript = ''; // Reset transcript
                    if (liveTranscript) {
                         liveTranscript.textContent = '';
                         liveTranscript.classList.remove('hidden');
                    }
                    if (startRecordingBtn) startRecordingBtn.classList.add('hidden');
                    if (stopRecordingBtn) stopRecordingBtn.classList.remove('hidden');
                    isRecording = true;
                    try {
                        recognition.start();
                    } catch (e) {
                         console.error("Error starting recognition:", e);
                         showMessage("Aufnahme konnte nicht gestartet werden.", true);
                         isRecording = false;
                         resetRecordingUI();
                    }
                }
            }
             
            // This function is triggered ONLY by the STOP button click now
            function stopRecognitionAndProcess() {
                 if (isRecording) {
                    isRecording = false; // Set flag first to prevent restart in onend
                    if (recognition) {
                         recognition.stop();
                    }
                    processRecordedTranscript();
                }
            }

            function processRecordedTranscript() {
                resetRecordingUI();
                 if (liveTranscript) liveTranscript.classList.add('hidden');
                
                var trimmedTranscript = finalTranscript.trim();
                console.log("Final Transcript Length:", trimmedTranscript.length);
                // console.log("Final Transcript:", trimmedTranscript); // Optional: Log for debugging


                if (trimmedTranscript.length < 20) { 
                    showMessage("Aufnahme zu kurz für eine sinnvolle Bearbeitung (" + trimmedTranscript.length + " Zeichen). Mindestens 20 benötigt.", true);
                    if (recordingStatus) recordingStatus.textContent = "Aufnahme war zu kurz. Bitte versuchen Sie es erneut.";
                    finalTranscript = ''; // Clear for next attempt
                    return;
                }
                
                if (recordingStatus) recordingStatus.innerHTML = '<div class="flex items-center gap-2"><div class="loader w-5 h-5 border-2 border-t-blue-500"></div> Transkript wird korrigiert...</div>';
                
                var correctionPrompt = 'Das folgende ist ein automatisch generiertes Transkript einer Vorlesung. Es enthält wahrscheinlich Fehler, Füllwörter und unvollständige Sätze aufgrund von schlechter Audioqualität. Bitte korrigiere den Text, um ihn grammatikalisch korrekt und lesbar zu machen. Entferne Füllwörter (wie "äh", "ähm"), vervollständige Sätze basierend auf dem Kontext, aber erfinde keine neuen fachlichen Inhalte. Gib nur den korrigierten Text zurück.\n\nTranskript:\n"' + trimmedTranscript + '"';

                callGeminiAPI(correctionPrompt).then(function(correctedTranscript) {
                    if (recordingStatus) recordingStatus.innerHTML = '<div class="flex items-center gap-2"><div class="loader w-5 h-5 border-2 border-t-blue-500"></div> Zusammenfassung wird erstellt...</div>';
                    var summaryPrompt = 'Du bist ein Experte für akademische Zusammenfassungen. Analysiere das folgende, korrigierte Vorlesungstranskript und extrahiere die wichtigsten Kernaussagen, Definitionen und Fakten. Präsentiere sie in einer klaren, strukturierten und leicht verständlichen Form auf Deutsch. Transkript: "' + correctedTranscript + '"';
                    return callGeminiAPI(summaryPrompt);
                }).then(function(summary) {
                    saveSummary(currentLecture.id, trimmedTranscript, summary); // Save original transcript for reference
                    if (recordingStatus) recordingStatus.textContent = "Zusammenfassung erfolgreich erstellt und gespeichert.";
                    finalTranscript = ''; // Clear after successful processing
                }).catch(function(error) {
                    showMessage("Fehler bei der KI-Bearbeitung: " + error.message, true);
                    if (recordingStatus) recordingStatus.textContent = "Bearbeitung konnte nicht erstellt werden.";
                    finalTranscript = ''; // Clear even if error occurred
                });
            }

            function resetRecordingUI() {
                if (stopRecordingBtn) stopRecordingBtn.classList.add('hidden');
                if (startRecordingBtn) startRecordingBtn.classList.remove('hidden');
                if (liveTranscript) liveTranscript.classList.add('hidden');
                // Ensure the status text is reset if no processing is happening
                if (recordingStatus && !recordingStatus.innerHTML.includes('loader')) {
                    recordingStatus.textContent = "Startklar.";
                }
            }
            function saveSummary(lectureId, transcript, summary) {
                var date = new Date().toISOString().split('T')[0]; 
                if (!appData.summaries[lectureId]) {
                    appData.summaries[lectureId] = [];
                }
                // Check if summary for this date already exists and replace it
                var existingIndex = -1;
                for(var i = 0; i < appData.summaries[lectureId].length; i++){
                    if(appData.summaries[lectureId][i].date === date){
                        existingIndex = i;
                        break;
                    }
                }
                var newSummary = { date: date, transcript: transcript, summary: summary, createdAt: new Date().toISOString() };
                if (existingIndex > -1) {
                    appData.summaries[lectureId][existingIndex] = newSummary;
                } else {
                     appData.summaries[lectureId].push(newSummary);
                }
                
                saveData();
                showMessage("Zusammenfassung gespeichert!");
                loadPastSummaries(lectureId); // Reload summaries in the UI
            }
            function loadPastSummaries(lectureId) {
                if (!pastSummariesContainer) return; // Add check
                pastSummariesContainer.innerHTML = '';
                var summaries = appData.summaries[lectureId] || [];

                if (summaries.length === 0) {
                    pastSummariesContainer.innerHTML = '<p class="text-gray-500">Keine Zusammenfassungen für diese Vorlesung gefunden.</p>';
                    return;
                }
                
                // Sort summaries by createdAt date, newest first
                var sortedSummaries = summaries.sort(function(a,b) { 
                    // Handle potential missing createdAt for older data
                    var dateA = a.createdAt ? new Date(a.createdAt) : new Date(a.date);
                    var dateB = b.createdAt ? new Date(b.createdAt) : new Date(b.date);
                    return dateB - dateA; 
                });

                sortedSummaries.forEach(function(summaryData) {
                    var detailElement = document.createElement('details');
                    detailElement.className = 'bg-gray-50 p-3 rounded-lg';
                    // Display date from 'date' field
                    var displayDate = new Date(summaryData.date).toLocaleDateString('de-DE');
                    var safeSummary = parseGeminiResponse(summaryData.summary || ''); // Ensure summary exists
                    detailElement.innerHTML = '<summary class="font-semibold cursor-pointer">Zusammenfassung vom ' + displayDate + '</summary><div class="prose max-w-none mt-2 pt-2 border-t text-sm">' + safeSummary + '</div>';
                    pastSummariesContainer.appendChild(detailElement);
                });
            }

            // --- Google Drive Functions ---
            function handleAuthClick() {
                if (GOOGLE_API_KEY === "DEIN_GOOGLE_DRIVE_API_KEY" || GOOGLE_CLIENT_ID === "DEINE_GOOGLE_DRIVE_CLIENT_ID.apps.googleusercontent.com") {
                    showMessage("Bitte zuerst Google API Key und Client ID im HTML-Code eintragen (siehe Anleitung).", true);
                    return;
                }
                if (!gapiInited || !gisInited) {
                    showMessage("Google API noch nicht geladen. Bitte kurz warten und erneut versuchen.", true);
                    return;
                }

                tokenClient.callback = function(resp) {
                    if (resp.error !== undefined) {
                         console.error("Google Auth Error:", resp);
                         showMessage("Google Drive Verbindung fehlgeschlagen: " + resp.error, true);
                         updateSigninStatus(false); // Ensure UI reflects failure
                         throw (resp);
                    }
                    updateSigninStatus(true);
                };

                // Check if already signed in - gapi.client might not be fully ready yet
                if (gapi.client && gapi.client.getToken && gapi.client.getToken() === null) {
                    // Prompt the user to select a Google Account and ask for consent to share their data
                    // when establishing a new session.
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    // Skip display of account chooser and consent dialog for an existing session.
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }

            function handleSignoutClick() {
                var token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                    updateSigninStatus(false);
                    driveFileId = null; // Reset file ID on signout
                }
            }
            
            function updateSigninStatus(isSignedIn) {
                 if (!driveAuthContainer || !driveActionContainer || !driveStatus) return; // Add checks
                if (isSignedIn) {
                    driveAuthContainer.classList.add('hidden');
                    driveActionContainer.classList.remove('hidden');
                    driveStatus.textContent = 'Verbunden mit Google Drive.';
                } else {
                    driveAuthContainer.classList.remove('hidden');
                    driveActionContainer.classList.add('hidden');
                    driveStatus.textContent = 'Verbinde dein Google-Konto, um Daten zu laden und zu sichern.';
                }
            }

            function findOrCreateFile() {
                 if (!gapi.client || !gapi.client.getToken || !gapi.client.getToken()) {
                    showMessage("Nicht mit Google Drive verbunden.", true);
                    return Promise.reject("Not signed in");
                 }
                 if (driveFileId) { // If we already know the ID, return it immediately
                     return Promise.resolve(driveFileId);
                 }
                // Search for the file
                return gapi.client.drive.files.list({
                    'q': "name='" + DATA_FILE_NAME + "' and mimeType='application/json' and trashed=false",
                    'spaces': 'drive', // Search only Drive, not shared spaces etc.
                    'fields': 'files(id, name)'
                }).then(function(response) {
                    var files = response.result.files;
                    if (files && files.length > 0) {
                        driveFileId = files[0].id; // Store the found ID
                        return files[0].id;
                    } else {
                        // File not found, create it
                        return gapi.client.drive.files.create({
                            resource: {
                                'name': DATA_FILE_NAME,
                                'mimeType': 'application/json'
                            },
                            fields: 'id' // Only request the ID of the new file
                        }).then(function(response) {
                            driveFileId = response.result.id; // Store the new ID
                            return response.result.id;
                        });
                    }
                });
            }

            function handleLoadFromDrive() {
                if (!gapi.client || !gapi.client.getToken || !gapi.client.getToken()) return showMessage("Nicht mit Google Drive verbunden.", true);
                if (!confirm("Möchtest du deine aktuellen lokalen Daten wirklich mit den Daten aus Google Drive überschreiben? Ungespeicherte lokale Änderungen gehen verloren.")) {
                    return;
                }
                showMessage("Lade Daten aus Drive...");
                driveLoadBtn.disabled = true; // Prevent double clicks
                driveSaveBtn.disabled = true;

                findOrCreateFile().then(function(fileId) {
                    if (!fileId) throw new Error("Konnte Datei-ID nicht finden oder erstellen.");
                    return gapi.client.drive.files.get({
                        'fileId': fileId,
                        'alt': 'media'
                    });
                }).then(function(response) {
                    var data = response.body;
                    if (data && data.length > 0) {
                         try {
                            var parsedData = JSON.parse(data);
                             if (typeof parsedData === 'object' && parsedData !== null) {
                                // Basic validation of structure before overwriting
                                if (Array.isArray(parsedData.lectures) && typeof parsedData.summaries === 'object' && Array.isArray(parsedData.icalSubscriptions)) {
                                    appData = parsedData; // Overwrite local data
                                     showMessage("Daten erfolgreich aus Google Drive geladen!", false);
                                } else {
                                     throw new Error("Datenformat in Drive ungültig.");
                                }
                            } else {
                                throw new Error("Datenformat in Drive ungültig.");
                            }
                         } catch (e) {
                             console.error("Error parsing data from Drive:", e);
                             throw new Error("Datenformat in Drive ungültig.");
                         }
                    } else {
                         // File exists but is empty, treat as loading an empty dataset
                         appData = { lectures: [], icalSubscriptions: [], summaries: {} };
                         showMessage("Leere Datei aus Drive geladen.", false);
                    }
                    saveData(); // Save the newly loaded (or empty) data locally
                    renderCurrentView();
                    renderIcalList();
                    fetchAllIcalEvents(); // Refetch iCal based on potentially new subscriptions
                }).catch(function(err) {
                    console.error("Error loading file from drive", err);
                     var userMessage = "Fehler beim Laden aus Drive: ";
                    if (err.status === 404 || (err.result && err.result.error && err.result.error.code === 404)) {
                        userMessage = "Speicherdatei in Drive nicht gefunden. Speichere zuerst, um sie zu erstellen.";
                    } else if (err.message) {
                         userMessage += err.message;
                    } else {
                         userMessage += "Unbekannter Fehler.";
                    }
                     showMessage(userMessage, true);
                }).finally(function() {
                    // Re-enable buttons regardless of success/failure
                     driveLoadBtn.disabled = false; 
                     driveSaveBtn.disabled = false;
                });
            }

            function handleSaveToDrive() {
                 if (!gapi.client || !gapi.client.getToken || !gapi.client.getToken()) return showMessage("Nicht mit Google Drive verbunden.", true);
                 showMessage("Speichere Daten in Drive...");
                 driveLoadBtn.disabled = true; // Prevent clicks during save
                 driveSaveBtn.disabled = true;

                 var content = JSON.stringify(appData);
                 // Using Blob for simpler upload with gapi.client.request and media upload
                 var blob = new Blob([content], { type: 'application/json' });

                findOrCreateFile().then(function(fileId) {
                    if (!fileId) throw new Error("Konnte Datei-ID nicht finden oder erstellen.");
                    
                     // Use media upload protocol
                     return gapi.client.request({
                        path: '/upload/drive/v3/files/' + fileId,
                        method: 'PATCH',
                        params: {
                             uploadType: 'media' // Use 'media' for simple content update
                        },
                        headers: {
                            'Content-Type': 'application/json' 
                        },
                        body: blob // Send the Blob directly
                    });

                }).then(function(response) {
                    console.log("Save successful:", response);
                    showMessage("Daten erfolgreich in Google Drive gespeichert!", false);
                }).catch(function(err) {
                    console.error("Error saving to drive", err);
                     var userMessage = "Fehler beim Speichern in Drive: ";
                     if (err.message) {
                         userMessage += err.message;
                     } else if (err.result && err.result.error && err.result.error.message) {
                          userMessage += err.result.error.message;
                     } else {
                         userMessage += "Unbekannter Fehler.";
                     }
                    showMessage(userMessage, true);
                }).finally(function() {
                    // Re-enable buttons regardless of success/failure
                     driveLoadBtn.disabled = false; 
                     driveSaveBtn.disabled = false;
                });
            }


            function setupEventListeners() {
                weekViewBtn.addEventListener('click', function() { switchView('week'); });
                monthViewBtn.addEventListener('click', function() { switchView('month'); });
                prevMonthBtn.addEventListener('click', function() {
                    displayedDate.setMonth(displayedDate.getMonth() - 1);
                    renderMonthView();
                });
                nextMonthBtn.addEventListener('click', function() {
                    displayedDate.setMonth(displayedDate.getMonth() + 1);
                    renderMonthView();
                });
                addIcalBtn.addEventListener('click', function() {
                    var url = icalUrlInput.value.trim();
                    if (!url) return showMessage("Bitte geben Sie eine URL ein.", true);
                    // Simple URL validation
                    if (url.indexOf('http') !== 0 || url.indexOf('.') === -1) {
                         return showMessage("Dies ist keine gültige URL.", true);
                    }
                    if (appData.icalSubscriptions.some(function(sub) { return sub.url === url; })) {
                        return showMessage("Dieser Kalender wurde bereits abonniert.", true);
                    }
                    appData.icalSubscriptions.push({ id: generateUUID(), url: url });
                    saveData();
                    renderIcalList();
                    fetchAllIcalEvents();
                    showMessage("Kalender wird abonniert...");
                    icalUrlInput.value = '';
                });
                addLectureBtn.addEventListener('click', function() { openModal(); });
                closeModalBtn.addEventListener('click', closeModal);
                lectureModal.addEventListener('click', function(e) { if (e.target === lectureModal) closeModal(); });
                prepareTodayBtn.addEventListener('click', handlePreparationClick);
                closePrepModalBtn.addEventListener('click', function() { preparationModal.classList.add('hidden'); });
                preparationModal.addEventListener('click', function(e) { if (e.target === preparationModal) preparationModal.classList.add('hidden'); });
                
                examPrepBtn.addEventListener('click', handleExamPrepClick);
                closeExamPrepModalBtn.addEventListener('click', function() { examPrepModal.classList.add('hidden'); });
                examPrepModal.addEventListener('click', function(e) { if (e.target === examPrepModal) examPrepModal.classList.add('hidden'); });

                closeDetailModalBtn.addEventListener('click', closeDetailModal);
                lectureDetailModal.addEventListener('click', function(e) { if (e.target === lectureDetailModal) closeDetailModal(); });
                editLectureBtn.addEventListener('click', function() {
                    closeDetailModal();
                    openModal(currentLecture);
                });
                startRecordingBtn.addEventListener('click', handleStartRecording);
                stopRecordingBtn.addEventListener('click', stopRecognitionAndProcess); 
                
                lectureForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var lectureData = { 
                        courseName: document.getElementById('courseName').value, 
                        lecturer: document.getElementById('lecturer').value, 
                        room: document.getElementById('room').value, 
                        dayOfWeek: document.getElementById('dayOfWeek').value, 
                        startTime: document.getElementById('startTime').value, 
                        endTime: document.getElementById('endTime').value 
                    };
                    var id = document.getElementById('lectureId').value;
                    
                    if (id) { // Editing
                        var index = -1;
                        for(var i=0; i < appData.lectures.length; i++) {
                            if(appData.lectures[i].id === id) {
                                index = i;
                                break;
                            }
                        }
                        if (index !== -1) {
                            // Use Object.assign for broader compatibility if needed, though direct assignment works here
                             appData.lectures[index].courseName = lectureData.courseName;
                             appData.lectures[index].lecturer = lectureData.lecturer;
                             appData.lectures[index].room = lectureData.room;
                             appData.lectures[index].dayOfWeek = lectureData.dayOfWeek;
                             appData.lectures[index].startTime = lectureData.startTime;
                             appData.lectures[index].endTime = lectureData.endTime;
                            showMessage("Vorlesung aktualisiert!");
                        }
                    } else { // Adding new
                        lectureData.id = generateUUID();
                        appData.lectures.push(lectureData);
                        showMessage("Vorlesung hinzugefügt!");
                    }
                    saveData();
                    renderCurrentView();
                    closeModal();
                });
                deleteLectureBtn.addEventListener('click', function() {
                    var id = document.getElementById('lectureId').value;
                    if(id) {
                         if (!confirm("Möchtest du diese Vorlesung und alle zugehörigen Zusammenfassungen wirklich löschen?")) {
                             return;
                         }
                        appData.lectures = appData.lectures.filter(function(l) { return l.id !== id; });
                        delete appData.summaries[id]; // Also delete associated summaries
                        saveData();
                        renderCurrentView();
                        showMessage("Vorlesung gelöscht!");
                        closeModal();
                    }
                });
                
                driveAuthBtn.addEventListener('click', handleAuthClick);
                driveSignoutBtn.addEventListener('click', handleSignoutClick);
                driveLoadBtn.addEventListener('click', handleLoadFromDrive);
                driveSaveBtn.addEventListener('click', handleSaveToDrive);
            }

            function showMessage(message, isError) {
                messageText.textContent = message;
                messageBox.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[100]';
                messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
                messageBox.classList.remove('hidden');
                setTimeout(function() { messageBox.classList.add('hidden'); }, 3000);
            }

            main();
        });
    </script>
</body>
</html>

